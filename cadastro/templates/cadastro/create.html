{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="content-wrapper">
<!-- Main content -->

    {% if messages %}
        <div class="row">
            <div class="col-lg-12">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible">
                    <button type="button" class="close" data-bs-dismiss="alert" aria-hidden="true">&times;</button>
                    {{ message }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            {% if form.instance.pk %}Editar{% else %}Cadastro{% endif %}
                        </h3>
                    </div>
                    <div class="container-fluid mt-5">
                      <form id="mainForm" method="post" enctype="multipart/form-data">
                          {% csrf_token %}
                          <!-- Adicionar campo hidden para operação de edição -->
                          {% if form.instance.pk %}
                            <input type="hidden" name="edit_mode" value="true">
                          {% endif %}
                            <input type="hidden" id="clienteId" name="cliente_id">
                            <input type="hidden" id="processoId" name="processo_id">

                          <ul class="nav nav-tabs" id="formTabs" role="tablist">
                              <li class="nav-item" role="presentation">
                                  <button class="nav-link active" id="cliente-tab" type="button" role="tab" aria-controls="cliente" aria-selected="true" onclick="showTab('cliente')">Dados do Cliente</button>
                              </li>
                              <li class="nav-item" role="presentation">
                                  <button class="nav-link" id="processo-tab" type="button" role="tab" aria-controls="processo" aria-selected="false" onclick="showTab('processo')">Dados do Processo</button>
                              </li>       
                              <li class="nav-item" role="presentation">
                                  <button class="nav-link" id="tarefa-tab" type="button" role="tab" aria-controls="tarefa" aria-selected="false" onclick="showTab('tarefa')">Dados da Tarefa</button>
                              </li>                                                
                          </ul>  
                          <div class="tab-content mt-4" id="formTabsContent">
                              <!-- Dados do Cliente -->
                              <div class="tab-pane fade show active" id="cliente" role="tabpanel" aria-labelledby="cliente-tab">
                                  <div class="row g-5">
                                      <div class="col-md-7">
                                          <div class="mb-3 row">
                                              <div class="col-md-7">
                                                  <label for="{{form.nome.id_for_label}}" class="form-label"> Cliente:</label>
                                                    {{form.nome}}
                                                    <div class="invalid-feedback">{{form.nome.errors}}</div>
                                              </div> 
                                              <div class="col-md-5">
                                                  <label for="{{form.cpf.id_for_label}}" class="form-label"> CPF:</label>
                                                      {{form.cpf}}
                                                      <div class="invalid-feedback">{{form.cpf.errors}}</div>
                                              </div>
                                              <div class="col-md-4">
                                                  <label for="{{form.data_de_nascimento.id_for_label}}" class="form-label"> Data de Nascimento:</label>
                                                      {{form.data_de_nascimento}}                                                                                                
                                              </div>
                                              <div class="col-md-4">
                                                  <label for="{{form.estado_civil.id_for_label}}" class="form-label"> Estado Civil:</label>
                                                      {{form.estado_civil}}                                                                                                 
                                              </div>     
                                              <div class="col-md-4">
                                                  <label for="{{form.profissao.id_for_label}}" class="form-label"> Profissão:</label>
                                                      {{form.profissao}}                                                                                                 
                                              </div>        
                                              <div class="col-md-6">
                                                  <label for="{{form.virou_cliente.id_for_label}}" class="form-label"> Virou cliente:</label>
                                                      {{form.virou_cliente}}                                                                                               
                                              </div>   
                                              <div class="col-md-6">
                                                  <label for="{{form.origem_cadastrado.id_for_label}}" class="form-label"> Origem:</label>
                                                      {{form.origem_cadastrado}}
                                              </div>
                                              <div class="col-md-6">
                                                  <label for="{{form.justificativa.id_for_label}}" class="form-label"> Justificativa:</label>
                                                      {{form.justificativa}}                                                                                                 
                                              </div>  
                                              <div class="col-md-6">
                                                  <label for="{{form.descricao.id_for_label}}" class="form-label"> Descrição:</label>
                                                      {{form.descricao}}                                                                                                 
                                              </div>
                                              <div class="col-md-4">
                                                  <label for="{{form.cep.id_for_label}}" class="form-label"> CEP:</label>
                                                      {{form.cep}}                                                                                                 
                                              </div>
                                              <div class="col-md-8">
                                                  <label for="{{form.rua.id_for_label}}" class="form-label"> Rua:</label>
                                                      {{form.rua}}                                                                                                  
                                              </div>
                                              <div class="col-md-2">
                                                  <label for="{{form.numero.id_for_label}}" class="form-label"> Número:</label>
                                                      {{form.numero}}                                                                                                 
                                              </div>
                                              <div class="col-md-5">
                                                  <label for="{{form.complemento.id_for_label}}" class="form-label"> Complemento:</label>
                                                      {{form.complemento}}                                                                                                 
                                              </div>
                                              <div class="col-md-5">
                                                  <label for="{{form.bairro.id_for_label}}" class="form-label"> Bairro:</label>
                                                      {{form.bairro}}                                           
                                              </div>
                                              <div class="col-md-4">
                                                  <label for="{{form.cidade.id_for_label}}" class="form-label"> Cidade:</label>
                                                      {{form.cidade}}                                 
                                              </div>
                                              <div class="col-md-4">
                                                  <label for="{{form.estado.id_for_label}}" class="form-label"> Estado:</label>
                                                      {{form.estado}}                                     
                                              </div>
                                              <div class="col-md-4">
                                                  <label for="{{form.email.id_for_label}}" class="form-label"> E-mail:</label>
                                                      {{form.email}}                                                      
                                              </div>
                                              <div class="col-md-4">
                                                  <label for="{{form.telefone.id_for_label}}" class="form-label"> Telefone:</label>
                                                      {{form.telefone}}       
                                                      <div class="invalid-feedback">{{form.telefone.errors}}</div>                                                                                         
                                              </div>
                                              <div class="col-md-4">                                                 
                                                    <label for="{{form.whatsapp.id_for_label}}" class="form-label"> Whatsapp</label>                                   
                                                      {{form.whatsapp}}
                                              </div>  
                                          </div>
                                          <!-- Botão para avançar para a próxima aba -->
                                          <div class="d-flex justify-content-between">
                                              <button type="button" class="btn btn-secondary" onclick="salvarEtapa()">Avançar</button>
                                          </div>
                                      </div>
                                      <!-- Coluna da Foto -->
                                      <div class="col-md-4 d-flex justify-content-end">                                                                       
                                        <div class="photo-container">
                                            {% comment %}
                                            {% if form.instance.foto %}
                                                <img src="{{ form.instance.foto.url }}" alt="Foto do cliente" class="img-thumbnail" id="foto-preview">
                                            {% else %}
                                                <div class="photo-placeholder">
                                                    {{ form.foto }}
                                                </div>
                                            {% endif %}
                                            {% endcomment %}
                                        </div>
                                      </div>                                                                          
                                  </div>                                
                              </div>  
                              <!-- Dados do Processo -->
                              <div class="tab-pane fade" id="processo" role="tabpanel" aria-labelledby="processo-tab">
                                  <div class="col-md-15">
                                      <div class="mb-3 row">
                                          <!-- Campo oculto para armazenar o cliente -->
                                                {{processo_form.cliente}}                                         
                                          <div class="col-md-4">
                                            <label for="{{processo_form.parceiro.id_for_label}}" class="form-label"> Parceiro:</label>
                                                {{processo_form.parceiro}}                                            
                                          </div>
                                          <div class="col-md-4">
                                            <label for="{{processo_form.advogado.id_for_label}}" class="form-label"> Advogado:</label>
                                                {{processo_form.advogado}}                                            
                                          </div>
                                          <div class="col-md-4">
                                            <label for="{{processo_form.numero_processo.id_for_label}}" class="form-label"> Número do Processo:</label>
                                                {{processo_form.numero_processo}}
                                          </div>
                                          <div class="col-md-4">
                                            <label for="{{processo_form.processo_status.id_for_label}}" class="form-label"> Status:</label>
                                                {{processo_form.processo_status}}
                                          </div>
                                          <div class="col-md-4">
                                            <label for="{{processo_form.grupo.id_for_label}}" class="form-label"> Grupo:</label>
                                                {{processo_form.grupo}}
                                          </div>
                                          <div class="col-md-4">
                                            <label for="{{processo_form.fase_processo.id_for_label}}" class="form-label"> Fase do Processo:</label>
                                                {{processo_form.fase_processo}}
                                          </div>                                                                                    
                                          <div class="col-md-4">
                                            <label for="{{processo_form.data_contrato.id_for_label}}" class="form-label"> Data da Contratação:</label>
                                                {{processo_form.data_contrato}}
                                          </div>                               
                                          <div class="col-md-4">                                                
                                            <label for="{{processo_form.fechou_contrato.id_for_label}}" class="form-label"> Fechou Contrato</label>
                                                {{processo_form.fechou_contrato}}
                                          </div>   
                                          <div class="col-md-4">
                                            <label for="{{processo_form.pendencia.id_for_label}}" class="form-label"> Pendência:</label>
                                                {{processo_form.pendencia}}                                            
                                          </div>   
                                          <div class="col-md-4">
                                            <label for="{{processo_form.descricao_processo.id_for_label}}" class="form-label"> Descrição:</label>
                                                {{processo_form.descricao_processo}}                                            
                                          </div>                                                                             
                                      </div>
                                  </div>
                                  <!-- Botões para avançar ou voltar -->
                                  <div class="d-flex justify-content-between">
                                        <a href="javascript:void(0);" class="btn btn-secondary" onclick="voltarParaCliente()">Voltar</a>
                                        <button type="button" class="btn btn-primary" onclick="salvarEtapa()">Avaçar</button>   
                                  </div>
                              </div>  
                              <!-- Dados da Tarefa -->
                              <div class="tab-pane fade" id="tarefa" role="tabpanel" aria-labelledby="tarefa-tab">
                                  <div class="col-md-15">
                                    <div class="mb-3 row">
                                        <!-- Campo oculto para armazenar o Número do Processo -->
                                                {{tarefa_form.processo}}                                            
                                        <div class="col-md-8">
                                            <label for="{{tarefa_form.responsaveis.id_for_label}}" class="form-label"> Responsável:</label>
                                                {{tarefa_form.responsaveis}}                                            
                                        </div>                                       
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.data.id_for_label}}" class="form-label"> Data:</label>
                                                {{tarefa_form.data}}                                            
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.hora.id_for_label}}" class="form-label"> Horário:</label>
                                                {{tarefa_form.hora}}                                            
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.tarefa.id_for_label}}" class="form-label"> Tarefa:</label>
                                                {{tarefa_form.tarefa}}                                            
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.prazo_fatal.id_for_label}}" class="form-label"> Prazo Fatal:</label>
                                                {{tarefa_form.prazo_fatal}}                                            
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.local.id_for_label}}" class="form-label"> Local:</label>
                                                {{tarefa_form.local}}                                            
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.prioridade_tarefa.id_for_label}}" class="form-label"> Importante:</label>
                                                {{tarefa_form.prioridade_tarefa}}
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.status.id_for_label}}" class="form-label"> Status:</label>
                                                {{tarefa_form.status}}                                            
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{tarefa_form.descricao_tarefa.id_for_label}}" class="form-label"> Descrição:</label>
                                                {{tarefa_form.descricao_tarefa}}                                            
                                        </div>                                        
                                    </div>
                                  </div>
  
                                  <!-- Botões para avançar ou voltar -->
                                  <div class="d-flex justify-content-between">
                                        <a href="javascript:void(0);" class="btn btn-secondary" onclick="voltarParaCliente()">Voltar</a>
                                        <button type="button" class="btn btn-primary" onclick="salvarEtapa()">Salvar </button>
                                  </div>
                              </div>                            
                          </div>
                      </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </section>
</div>

<!-- Botão "Sair" -->
<div style="position: fixed; bottom: 20px; right: 20px;">
    <a href="{% url 'cadastro:list' %}" class="btn btn-danger" title="Sair">
      <i class="fas fa-sign-out-alt"></i> Sair
    </a>
</div>

{% endblock %}

{% block extra_script %}
<script>
    let currentTab = 'cliente';
    let clienteId = null;
    let processoId = null;

    function showTab(tabName) {
        if (!tabName) {
            console.error("String vazia passada para showTab().");
            return;
        }
        
        currentTab = tabName;

        // Esconde todas as abas
        const tabs = document.querySelectorAll('.tab-pane');
        tabs.forEach(tab => tab.classList.remove('show', 'active'));

        // Exibe a aba correspondente
        const activeTab = document.getElementById(tabName);
        if (activeTab) {
            activeTab.classList.add('show', 'active');
        } else {
            console.error(`Aba com ID '${tabName}' não encontrada.`);
            return;
        }

        // Altera o estado ativo do botão da aba
        const buttons = document.querySelectorAll('.nav-link');
        buttons.forEach(button => button.classList.remove('active'));

        const activeButton = document.querySelector(`#${tabName}-tab`);
        if (activeButton) {
            activeButton.classList.add('active');
        } else {
            console.error(`Botão da aba com ID '${tabName}-tab' não encontrado.`);
            return;
        }

        // Preenche campos ocultos com IDs
        if (tabName === 'processo') {
            const clienteIdField = document.querySelector('[name="cliente"]');
            if (clienteIdField && clienteId) {
                clienteIdField.value = clienteId;
            }
        }

        if (tabName === 'tarefa') {
            const processoIdField = document.querySelector('#tarefa [name="processo"]');
            if (processoIdField && processoId) {
                processoIdField.value = processoId;
            }
        }
    }
    
    function salvarEtapa() {
        const formElement = document.getElementById('mainForm');
        if (!formElement) {
            console.error('Formulário principal não encontrado');
            return;
        }

        const isUpdate = window.location.pathname.includes('/update/');
        const url = isUpdate ? window.location.pathname : "{% url 'cadastro:create' %}";

        const formData = new FormData(formElement);
        formData.append('etapa', currentTab);

        // Limpa mensagens de erro anteriores
        clearErrors();

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw err;
                }).catch(() => {
                    throw new Error('Erro no servidor');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Atualiza IDs
                if (data.cliente_id) clienteId = data.cliente_id;
                if (data.processo_id) processoId = data.processo_id;

                // Navegação
                if (currentTab === 'cliente' && data.next_etapa === 'processo') {
                    showTab('processo');
                } else if (currentTab === 'processo' && data.next_etapa === 'tarefa') {
                    showTab('tarefa');
                } else if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
                
                if (data.message) {
                    alert(data.message); // Ou exibir em um toast
                }
            } else {
                throw data;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.errors) {
                showFieldErrors(error.errors);
            } else {
                alert('Erro: ' + (error.message || 'Ocorreu um erro desconhecido'));
            }
        });
    }


    function clearErrors() {
        document.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(el => {
            el.textContent = '';
        });
    }

    function showFieldErrors(errors) {
        for (const field in errors) {
            const input = document.querySelector(`[name="${field}"]`);
            if (!input) {
                console.warn(`Campo ${field} não encontrado no formulário`);
                continue;
            }
            
            // Adiciona classe de erro ao input
            input.classList.add('is-invalid');
            
            // Tenta encontrar o elemento de mensagem de erro de várias formas
            let errorElement = null;
            
            // 1. Verifica se há um irmão com a classe invalid-feedback
            errorElement = input.nextElementSibling;
            if (errorElement && errorElement.classList.contains('invalid-feedback')) {
                errorElement.textContent = errors[field].join(', ');
                continue;
            }
            
            // 2. Procura dentro do grupo de formulário
            const formGroup = input.closest('.mb-3, .form-group, .col-md-4, .col-md-6, .col-md-8');
            if (formGroup) {
                errorElement = formGroup.querySelector('.invalid-feedback');
                if (errorElement) {
                    errorElement.textContent = errors[field].join(', ');
                    continue;
                }
            }
            
            // 3. Se não encontrou, cria um elemento temporário
            console.warn(`Elemento de erro não encontrado para o campo ${field}`);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.textContent = errors[field].join(', ');
            errorDiv.style.color = 'red';
            
            // Insere após o input ou no final do container
            input.parentNode.insertBefore(errorDiv, input.nextSibling);
        }
    }

    function voltarParaCliente() {
        showTab('cliente');
    }

    function voltarParaProcesso() {
        showTab('processo');
    }

    window.addEventListener('DOMContentLoaded', function () {
        // Preenche hora atual se vazio
        const horaInput = document.querySelector('#tarefa input[name="hora"]');
        if (horaInput && !horaInput.value) {
            const now = new Date();
            horaInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }
        
        // Carrega IDs se for update
        if (window.location.pathname.includes('/update/')) {
            clienteId = window.location.pathname.split('/').filter(Boolean).pop();
            
            const processoIdField = document.querySelector('#tarefa [name="processo"]');
            if (processoIdField?.value) {
                processoId = processoIdField.value;
            }
        }
    });

    // Inicializa mostrando a aba do cliente
    showTab('cliente');    
</script>
{% endblock %}